(function(a,b){'object'==typeof exports&&'object'==typeof module?module.exports=b():'function'==typeof define&&define.amd?define('early-parser',[],b):'object'==typeof exports?exports['early-parser']=b():a['early-parser']=b()})(this,function(){return(()=>{'use strict';var a={};(()=>{a.r=(a)=>{'undefined'!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(a,Symbol.toStringTag,{value:'Module'}),Object.defineProperty(a,'__esModule',{value:!0})}})();var b={};a.r(b);const c=new WeakMap;const d=(a)=>[a[0],a.slice(1)];const e=new WeakMap,f=(a)=>{a=Array.isArray(a)?a:[a];const b=1<a.length&&'string'==typeof a[0]?a.splice(0,1)[0]:null;return a.map((a)=>(Array.isArray(a)?a=a.map(g):void 0!==a&&a.type?a=g(a):void 0!==a&&(a=[a]),void 0!==a&&b&&(a.type=b),a))},g=(a)=>{const b=a.action;if(b&&'function'==typeof b){let c;return(c=a.children?b([a.type].concat(a.children)):b([a.type,a.value]),null===c)?[]:(c=f(c),Array.isArray(c)&&!c.type?flattenList(c,!0):c)}return[void 0===a.value?a:a.value]},h=(a)=>a.map((a)=>g(a)),i=(a,b)=>'object'==typeof b?b.test(a):b===a,j=(a,b,c,d)=>{const e=b.find(({lhs:a})=>c.length&&c[0]===a);if(e){const{action:b,rhs:c,lhs:f}=e;return c.some((c)=>n(a,d,new State({lhs:f,left:[],right:c,dot:0,from:d,action:b},e)))}return!1},k=(a,{type:b,value:c},d,e)=>{if(d.right.length){const f=d.right[0],g=f===b?b:c,h='object'==typeof f||f===b?f:0===f.indexOf('"')?f.slice(1,-1):f;if(i(g,h)){const b=new State({lhs:d.lhs,left:[...d.left,f],dot:d.dot+1,right:d.right.slice(1),from:d.from,action:d.action}),g=n(a,e+1,b);return g&&(b.previous=[d],d.token=c),g}return!1}return!1},l=(a,b,c)=>a[b.from].some((d)=>{const{right:e,left:f,dot:g,lhs:h,from:i,action:j}=d;if(!b.right.length&&e.length&&e[0]===b.lhs){const k=new State({lhs:h,left:[...f,e[0]],right:e.slice(1)||[],dot:g+1,from:i,action:j}),l=n(a,c,k);return l&&(k.previous=[...d.previous,b]),l}return!1}),m=(a,b)=>a.some(({lhs:a,right:c,left:d,from:e})=>a===b.lhs&&c.join(' ')===b.right.join(' ')&&d.join(' ')===b.left.join(' ')&&e===b.from),n=(a,b,c)=>{let d=a[b];d||(d=[],a[b]=d);const e=m(d,c);return e||d.push(c),!e},o=(a,b)=>a[a.length-1].filter((a)=>a.complete&&0===a.from&&a.lhs===b.lhs);const p=new WeakMap,q={type:'SYMBOL',reg:/./},r=(a)=>{const{states:b}=p.get(a),c={name:'INITIAL',tokens:b.length?b[0].tokens:[q],error:null,start:0,end:null};p.get(a).state=c,p.get(a).states=[c]},s=(a,b,c)=>{throw new Error(`${a} (line: ${b}, col: ${c})`)},t=(a,b,c,d,e)=>({type:a,value:b,line:c,col:d,index:e});class Lexer{constructor(){const a=this;p.set(a,{TOKEN:t,throwError:s,input:'',index:0,col:0,line:1,state:null,states:[],setInitialState:r}),r(a)}set line(a){p.get(this).line=a}get line(){return p.get(this).line}set col(a){p.get(this).col=a}get col(){return p.get(this).col}set index(a){p.get(this).index=a}get index(){return p.get(this).index}get source(){return p.get(this).input}reset(){const a=this,{setInitialState:b}=p.get(a);b(a),a.index=0,a.col=0,a.line=1}error(a){p.get(this).state.error=a}state(a,b){const c=this,{states:d,state:e}=p.get(c),f={name:a,tokens:[],error:null,start:c.index,end:null};p.get(c).state=f,b(c),d.push(f),p.get(c).state=e}input(a){p.get(this).input=a}tokens(a=[]){const b=this,{state:c}=p.get(b);c.tokens=[],a.forEach((a)=>{Array.isArray(a)?c.tokens.push({type:a[0],reg:a[1]}):c.tokens.push(a)})}ignore(a){p.get(this).state.tokens.unshift({type:'IGNORE',reg:a})}skip(a){return this.index+=a,this.readToken()}peak(){const a=this,b=a.index,c=a.line,d=a.col,e=p.get(a).state,f=this.readToken();return a.index=b,a.line=c,a.col=d,p.get(a).state=e,f}readToken(){const a=this,{TOKEN:b,throwError:c,state:d,states:e,input:f}=p.get(a);if(!f)return null;const g=d.tokens,h=f.substring(a.index);if(0===h.length)return null;let i=null;for(const c of g){const g=c.reg;let j=h.match(g);if(j){j=j[0];const g=a.index,h=a.col,k=a.line;if(a.col+=j.length,a.index+=j.length,'IGNORE'===c.type)return a.readToken();if('NEWLINE'===c.type){if(!(c.cb&&'function'==typeof c.cb))return a.line+=1,a.col=0,a.readToken();if(!c.cb(a))return a.readToken()}if(c.begin){const b=e.find((a)=>a.name===c.begin);return b.start=a.index,d.end=g,p.get(a).state=b,c.cb&&'function'==typeof c.cb&&c.cb(f.substring(d.start,d.end),a),a.readToken()}if(i=b(c.type,c.value?c.value(j):j,k,h,g),i)return i}}return d.error?d.error(a):void c(`Lexer: Illegal character ${h[0]} `,a.line,a.col)}}const u=new WeakMap;class Global{}class Environment{constructor(a=null,b=null){const c=this;let d=a?null:b||new Global;const e=a?{}:d,f=new Proxy(e,{get(b,c){if(b.hasOwnProperty(c))return Reflect.get(b,c);if(a)return a.get(c);throw new ReferenceError(`${c} is not defined`)},set(b,c,d){if(b.hasOwnProperty(c))return Reflect.set(b,c,d);if(a)return a.set(c,d);throw new ReferenceError(`${c} is not defined`)}});u.set(c,{_variables:e,_proxy:f,_parent:a,_this:d})}get parent(){return u.get(this)._parent}get this(){return u.get(this)._this}set this(a){return u.get(this)._this=a}extend(){return new Environment(this)}define(a,b,c=void 0){if('var'!==b&&u.get(this)._variables.hasOwnProperty(a))throw new SyntaxError(`Identifier '${a}' has already been declared`);return u.get(this)._variables[a]=c}get(a){return u.get(this)._proxy[a]}set(a,b){return u.get(this)._proxy[a]=b}}return b})()});